<!-- You must include this JavaScript file 
   -->
<!DOCTYPE html>
<head>
   <title>Drawing Behaviors</title>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="css/main.css">
   <!-- bootbox.js at 4.4.0 -->
   <script src="https://rawgit.com/makeusabrew/bootbox/f3a04a57877cab071738de558581fbc91812dce9/bootbox.js"></script>
</head>
<!-- For the full list of available Crowd HTML Elements and their input/output documentation,
   please refer to https://docs.aws.amazon.com/sagemaker/latest/dg/sms-ui-template-reference.html -->
<div class="container mt-5">
   <h2>Collection for a Drawing Dataset</h2>
   <div class="row">
      <div class ="col">
         <div class="mt-2 p-2 bg-dark text-white rounded">
            <div class = "row">
               <div class = "col">
                  <p>
                     <strong>Instructions: </strong>
                     <!-- 
                        This interface will be used for making trajectories with the four
                        characteristics  seen below.  After you are finished drawing, 
                        you will see video playback below the canvas. The first 
                        characteristic indicates what type of object should be drawn in the position 
                        indicated by the third characteristic.  The second characteristic indicates 
                        the type of trajectory the artist must create in accordance with
                        the other characteristics. Location marks both the end of the trajectory 
                        and where the shape must be drawn. Finally, the fourth characteristic is the 
                        speed at which the drawing should be made.  Before confirming your submission, 
                        you should make sure that the video playback of your drawing contains all of 
                        the following characteristics: 
                        --> 
                     Please input your drawing in the canvas (white box) as per instructions. 
<span>Draw a <strong id=size></strong>-sized and <strong
id=rotation></strong>-rotated <span id="symbol9">    </span>  
              at a <strong id=speed></strong> speed in any
location,
</span>
or:
<div class="rotateup" id="symbol">  <div class="center" id="symbol8"> </div>
</div> 

                    If you click no after pressing submit, you will
                     be able to start over. Note that you can let go of the left 
                     click without stopping the video. 
                     
                     Please note that this application only works in a desktop
browser.
                      
                    The instructions consist of four characteristic components: 
                     
                     <br>
                     <br> 
                     1. Symbol: The Letter/Number to be drawn. You need to draw a
<span id= "symbol1" ></span>

                     </br>
                     <br> 
                     2. Size: Size of the Letter/Number. Draw a <strong id
="size2" ></strong> <span id=symbol2></span>.
                     </br>
                     <br> 
                     3. Rotation: Point the top of the letter/number in this
direction. Point the top of your <span id = "symbol3" ></span> <strong id=
"rotation2"></strong>. 
<div class="grid-container">
<div> Up:</div>
<div class="rotateup" id="symbol4">  </div> 
<div> Left:</div>
<div class="rotateleft" id="symbol5">  </div> 
<div> Down:</div>
<div class="rotatedown" id="symbol6">  </div> 
<div> Right:</div>
<div class="rotateright" id="symbol7">  </div> 
</div>
                     </br>
                     <br> 
                     4. Speed: Speed at which you draw your letter/number.
Draw at a <strong id="speed2"></strong> speed.
                     </br>

                  </p>
                  <div>
                     For further instructions, please see following example video:
                  </div>
                  <div class = "row">
                     <div class = "row">
                        <div class = "col">
                           <iframe width="560" height="315" src="https://www.youtube.com/embed/4UIMm5AUi-Q" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                     </div>
                     <p id=behavior_words></p>
                  </div>

                  <div class="container mt-5"></div>
               </div>
               <div class = "col">
                  <div class = "col">
                        <div class="row">
   <div style="text-align: center padding: 10" class = "col">
      <input id="smit" class="btn btn-primary w-10" type="submit" value="Submit">
      <input id="vvid" class="btn btn-primary w-10" style = "padding = 10" type="submit" value="View Video">
      <input id="cboard" class="btn btn-primary w-10" type="submit" value="Clear Board">
      <input id="ddata" class="btn btn-primary w-10" type="submit" value="Download Data">
   </div>
                        </div>
                        <div class="row">
                     <div id="sketch" class="row">
                        <div class="col">
                           <canvas id="paint" style="background-color: white"width = 480 height = 360 class="border border-dark rounded">
                           We're sorry, the browser you are using does not support 
                           <canvas>
                              . Please upgrade your browser. 
                              <!--Anything inside of the canvas tag will only display if the browser does not support the <canvas> tag.-->
                           </canvas>
                        </div>

                           <video id="video1" class="border border-dark rounded" width = 480 height = 360 autoplay controls></video>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>

    <div class = "col" >
        <div class = "row">
            <div class = "col" style="padding: 0">

                   <p> Symbol: O, Size: medium, Rotation: left, Speed: fast</p> 
               <iframe width="350" height="200" src="https://www.youtube.com/embed/Ia91wH61Vv0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div> 
            <div class = "col"style="padding: 0">
            
                   <p> Symbol: H, Size: small, Rotation: down, Speed: slow </p> 
                      <iframe width="350" height="200" src="https://www.youtube.com/embed/FNOZzDZHQWo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            </div>
            <div class = "col"style="padding: 0">
            
                   <p> Symbol: one, Size: small, Rotation: left, Speed: fast </p> 
                      <iframe width="350" height="200" src="https://www.youtube.com/embed/Nrl5u1dE_Qw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            </div>
            <div class = "col"style="padding: 0">
            
                   <p>Symbol: A, Size:  small, Rotation: down, Speed: slow</p> 
                      <iframe width="350" height="200" src="https://www.youtube.com/embed/70p_IEXCoPo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            </div>
            <div class = "col"style="padding: 0">
            
                   <p>Symbol: J, Size: medium, Rotation: left, Speed: fast </p> 
                      <iframe width="350" height="200" src="https://www.youtube.com/embed/5Qi_ndWNCAo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            </div>
            <div class = "col"style="padding: 0">
            
                   <p>Symbol: Z, Size: large, Rotation: up, Speed: slow </p> 
                      <iframe width="350" height="200" src="https://www.youtube.com/embed/TQiUTEMKmjo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

            </div>
        </div>
    </div>
   
  
    </div> 
</div>
<body>
   <!-- You must include crowd-form so that your task submits answers to MTurk -->
   <script>
      // This part of the code is used for generating the random words to describe
      // the task being completed.
      var startExpTime = null;
      
      let words1 = "0 1 2 3 4 5 6 7 8 9 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z";
      var words1Array = words1.split(' ');
      let words2 = "small medium large";
      var words2Array = words2.split(' ');
      let words3 = "left up right down" 
      var words3Array = words3.split(' ');
      let words4 = "slow fast" 
      var words4Array = words4.split(' ');
      var selected_word1  = words1Array[Math.floor(Math.random()*words1Array.length)];
      var selected_word2  = words2Array[Math.floor(Math.random()*words2Array.length)].replaceAll('_',' ');
      var selected_word3  = words3Array[Math.floor(Math.random()*words3Array.length)].replaceAll('_',' ');
      var selected_word4  = words4Array[Math.floor(Math.random()*words4Array.length)];
//      var task = " <table style='width:100%'> <tr> <th>Shape:</th> <th>" + selected_word1 + "</th> </tr> <br>"  + " <tr> <th>Trajectory:</th> <th>" + selected_word2 + "</th> </tr> <br>"  + " <tr> <th>Location: </th> <th>"+ selected_word3 + "</th> </tr>"  + " <tr> <th>Speed: </th> <th>"+ selected_word4 + "</th> </tr> </table>";
//      console.log(task);
//      document.getElementById("behavior_words").innerHTML = task;
      document.getElementById("size").innerHTML = selected_word2;
//      document.getElementById("symbol").innerHTML = selected_word1;
      document.getElementById("symbol8").innerHTML = selected_word1;
      document.getElementById("speed").innerHTML = selected_word4;
      
      classname = "rotates" + selected_word3;
      document.getElementById("size").innerHTML = selected_word2;;
      document.getElementById("size2").innerHTML = selected_word2;;
      document.getElementById("rotation").innerHTML = selected_word3;
      document.getElementById("rotation2").innerHTML = selected_word3;
      document.getElementById("symbol1").innerHTML = selected_word1;
      document.getElementById("symbol1").className =classname;
      document.getElementById("symbol2").innerHTML = selected_word1;
      document.getElementById("symbol2").className =classname;
      document.getElementById("symbol3").innerHTML = selected_word1;
      document.getElementById("symbol3").className =classname;
      console.log( document.getElementById("symbol3").className   );
      document.getElementById("symbol4").innerHTML = selected_word1;
      document.getElementById("symbol5").innerHTML = selected_word1;
      document.getElementById("symbol6").innerHTML = selected_word1;
      document.getElementById("symbol7").innerHTML = selected_word1;
      document.getElementById("symbol9").innerHTML = selected_word1;
      document.getElementById("symbol9").className =classname
      document.getElementById("speed").innerHTML = selected_word4;
      document.getElementById("speed2").innerHTML = selected_word4;
      console.log(selected_word3 == "up");
      console.log(selected_word3);
 

      document.getElementById("symbol").className ="rotate" + selected_word3 + selected_word2;
        
      // This code is used for creating the media recorder associated with the
      // canvas element.
      var canvas = document.getElementById("paint");
      //  canvas.width = window.innerWidth
      // canvas.height = window.innerHeight
      var context = canvas.getContext("2d");
      var videoStream = canvas.captureStream(30); 
      var chunks = [];
      var strokes = [];
      var mediaRecorder = new MediaRecorder(videoStream);
      var video = document.getElementById("video1"); 
      mediaRecorder.ondataavailable = function(e) {
        chunks.push(e.data);
        var blob = new Blob(chunks, { 'type' : 'video/mp4' });
        var videoURL = URL.createObjectURL(blob);
        video.src = videoURL;
//        console.log(blob)
      };

//      console.log(Object.getOwnProprtyNames(mediaRecorder));
      mediaRecorder.onpause = function(e) {
        mediaRecorder.requestData();
      };
       mediaRecorder.onstop = function(e) {
        var blob = new Blob(chunks, { 'type' : 'video/mp4' });
        var videoURL = URL.createObjectURL(blob);
        video.src = videoURL;
      };     

      function onPaint() {
            ctx.beginPath();
            ctx.moveTo(last_mouse.x, last_mouse.y);
            ctx.lineTo(mouse.x, mouse.y);
            ctx.closePath();
            ctx.stroke();
      }
      
      // This function is going to be used for adding event listeners
      function confirm_dialog() {
            bootbox.dialog({
        message: "Do you wish to confirm this drawing??",
        buttons: {
            ok: {
                label: 'Yes',
                className: 'btn-success',
                callback: sendJSON
            },
            cancel: {
                label: 'No',
                className: 'btn-danger',
                callback: clearboard
            }
        },
        callback: function (result) {
            console.log('This was logged in the callback: ' + result);
        }
      });        
      
      
//       canvas.removeEventListener('mousemove', onPaint, false);
       canvas.removeEventListener('touchmove', onPaint, false);
      
      
      }
      var smit = document.getElementById("smit");
      console.log(smit);
      if(smit.addEventListener){
        console.log(smit.addEventListener);
        smit.addEventListener("click", confirm_dialog ,false);
      } 
      else{
        //ie doesn't have addEventListner
        smit.attachEvent('onsubmit', confirm_dialog );
      }
      var vvid = document.getElementById("vvid");
      console.log(vvid);
      if(vvid.addEventListener){
        console.log(vvid.addEventListener);
        vvid.addEventListener("click", play_video ,false);
      } 
      else{
        //ie doesn't have addEventListner
        vvid.attachEvent('onsubmit', play_video );
      }
      var cboard = document.getElementById("cboard");
      console.log(cboard);
      if(cboard.addEventListener){
        console.log(cboard.addEventListener);
        cboard.addEventListener("click", clearboard ,false);
      } 
      else{
        //ie doesn't have addEventListner
        cboard.attachEvent('onsubmit', clearboard );
      }
      
     
      var ddata = document.getElementById("ddata");
      console.log(ddata);
      if(ddata.addEventListener){
        console.log(ddata.addEventListener);
        ddata.addEventListener("click", download_data ,false);
      } 
      else{
        //ie doesn't have addEventListner
        ddata.attachEvent('onsubmit', download_data );
      }
      function play_video(){
        var blob = new Blob(chunks, { 'type' : 'video/mp4' });
        var videoURL = URL.createObjectURL(blob);
        video.src = videoURL;
      }
      
      // Clear the canvas
      function clearboard(){
      
      var canvas = document.getElementById("paint");
      var context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height)
      chunks = [];
      strokes = [];
      mediaRecorder.stop();
      
      }
      function sendJSON(){
      var totalTime = (new Date()) - startExpTime;
      var newDate = new Date();
      $('#assignmentId').val(GetAssignmentId());
      var curID = (IsOnTurk())? GetAssignmentId() : prompt("Doesn't look like you " + 
      "are on Turk, so you're probably testing. Enter an ID to save your data with:", "id");
                 var blob = new Blob(chunks, { 'type' : 'video/webm' });
                 console.log(blob)
                console.log(chunks);
                var formData = new FormData();
      //formData.append("curID", curID,) 
      console.log(GetAssignmentId());

      
      
        const urlParams = new URLSearchParams(window.location.search)
       
        // create the form element and point it to the correct endpoint
        const form = document.createElement('form')
       form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
//      form.action = "https://workersandbox.mturk.com/mturk/externalSubmit";
//      form.action = "https://mturk.com/mturk/externalSubmit";
        form.method = 'post'
       
        // attach the assignmentId
        const inputAssignmentId = document.createElement('input')
        inputAssignmentId.name = 'assignmentId'
        inputAssignmentId.value = urlParams.get('assignmentId')
        inputAssignmentId.hidden = true
        form.appendChild(inputAssignmentId)
       
        // attach data I want to send back
      data1 = createDataElement("Symbol", selected_word1);
      form.appendChild(data1);
      data2 = createDataElement("Size", selected_word2);
      form.appendChild(data2);
      data3 = createDataElement("Rotation", selected_word3);
      form.appendChild(data3);
      data4 = createDataElement("Speed", selected_word4);
      form.appendChild(data4);
      data5 = createDataElement("Strokes", strokes);
      form.appendChild(data5)
      //video = createDataElement("video", blob);
      const video = document.createElement("input");
      video.name = "video";
      //  video.value =  JSON.stringify(blobToBase64(blob));
      (async () => {
      const b64 = await blobToBase64(blob);
      const jsonString = JSON.stringify({blob: b64});
      video.value = jsonString;
        video.hidden = true;
      form.appendChild(video);
      console.log(video); 
        // attach the form to the HTML document and trigger submission
        document.body.appendChild(form)
        form.submit()
      })();
      

        
      }
      function GetWorkerId() {
        var workerId = turkGetParam( 'workerId', 'NONE' );
        return workerId;
      }	
      const blobToBase64 = (blob) => {
      return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = function () {
      resolve(reader.result);
      };
      });
      };
      const getMethods = (obj) => {
      let properties = new Set()
      let currentObj = obj
      do {
      Object.getOwnPropertyNames(currentObj).map(item => properties.add(item))
      } while ((currentObj = Object.getPrototypeOf(currentObj)))
      return [...properties.keys()].filter(item => typeof obj[item] === 'function')
      }
      function IsTurkPreview() {
      return GetWorkerId() == "NONE";
      }	
      function createDataElement(name, data){
      const newdata = document.createElement("input");
      newdata.name = name;
        newdata.value = JSON.stringify(data)
        newdata.hidden = true
      return  newdata
      }
      
      function IsOnTurk() {
      try {
      return ((window.location.host.indexOf('mturk')!=-1) || document.forms["mturk_form"] ||
      (top != self && window.parent.location.host.indexOf("mturk") != -1));
      } catch(err) {
      // insecure content trying to access https://turk probably, so say yes:
      return true;
      }
      }
      
      function GetAssignmentId() {
      var assignmentId = turkGetParam( 'assignment_id', 'NONE' );
      return assignmentId;
      }	
      function download_data(){
      var totalTime = (new Date()) - startExpTime;
      var newDate = new Date();
      $('#assignmentId').val(GetAssignmentId());
                 var blob = new Blob(chunks, { 
                                             'type' : 'video/webm' 
                                             } );
      thisdata = {};
      datalist = [];
      thisdata.datalist = datalist
      thisdata.datalist.push({"Symbol" : selected_word1});
      thisdata.datalist.push({"Size" : selected_word2});
      thisdata.datalist.push({"Rotation" : selected_word3});
      thisdata.datalist.push({"Speed" : selected_word4});
      thisdata.datalist.push({"Strokes": JSON.stringify(strokes)});
      var dt = new Date( "December 25, 1995 23:15:20" );
      (async () => {
      const b64 = await blobToBase64(blob);
      const jsonString = JSON.stringify({blob: b64});
      thisdata.datalist.push({"Video": jsonString})
      var a = document.createElement("a");
      var file = new Blob([JSON.stringify(thisdata)], {type: 'text/plain'});
      a.href = URL.createObjectURL(file);
      console.log(selected_word1)
      a.download = dt.getTime() + '_draw_data.txt', 'text/plain';
      a.click();
      })();
      
      
      }

      function download(content, fileName, contentType) {

      }
      
      /**
      * Gets a URL parameter from the query string
      */
      function turkGetParam( name, defaultValue ) { 
      var regexS = "[\?&]"+name+"=([^&#]*)"; 
      var regex = new RegExp( regexS ); 
      var tmpURL = window.location.href; 
      var results = regex.exec( tmpURL ); 
      if( results == null ) { 
      return defaultValue; 
      } else { 
      return results[1];    
      } 
      }
      
      /**
      * URL decode a parameter
      */
      function decode(strToDecode)
      {
      var encoded = strToDecode;
      return unescape(encoded.replace(/\+/g,  " "));
      }
      
      
      /**
      * Returns the Mechanical Turk Site to post the HIT to (sandbox. prod)
      */
      function turkGetSubmitToHost() {
      return decode(turkGetParam("turkSubmitTo", "https://www.mturk.com"));
      }
      
      
      /**
      * Sets the assignment ID in the form. Defaults to use mturk_form and submitButton
      */ 
      function turkSetAssignmentID( form_name, button_name ) {
      
      if (form_name == null) {
      form_name = "mturk_form";
      }
      
      if (button_name == null) {
      button_name = "submitButton";
      }
      
      assignmentID = turkGetParam('assignmentId', "");
      document.getElementById('assignmentId').value = assignmentID;
      
      if (assignmentID == "ASSIGNMENT_ID_NOT_AVAILABLE") { 
      // If we're previewing, disable the button and give it a helpful message
      btn = document.getElementById(button_name);
      if (btn) {
      btn.disabled = true; 
      btn.value = "You must ACCEPT the HIT before you can submit the results.";
      } 
      }
      
      form = document.getElementById(form_name); 
      if (form) {
      form.action = turkGetSubmitToHost() + "/mturk/externalSubmit"; 
      }
      }
      
      (function() {
        var canvas = document.querySelector('#paint');
        var ctx = canvas.getContext('2d');
      
        var sketch = document.querySelector('#sketch');
        var sketch_style = getComputedStyle(sketch);
      //    canvas.width = parseInt(sketch_style.getPropertyValue('width'));
      //    canvas.height = parseInt(sketch_style.getPropertyValue('height'));
      
        var mouse = {x: 0, y: 0};
        var last_mouse = {x: 0, y: 0};
      
        /* Mouse Capturing Work */
//        canvas.addEventListener('mousemove', function(e) {
//            last_mouse.x = mouse.x;
//            last_mouse.y = mouse.y;
//      
//            mouse.x = e.pageX - this.offsetLeft;
//            mouse.y = e.pageY - this.offsetTop;
//        }, false);
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault(); // This prevents the window from scrolling

            last_mouse.x = mouse.x;
            last_mouse.y = mouse.y;

            mouse.x = e.touches[0].pageX - this.offsetLeft;
            mouse.y = e.touches[0].pageY - this.offsetTop;
        }, { passive: false }); // Use an options object with passive set to false

           
      
        /* Drawing on Paint App */
        ctx.lineWidth = "15";
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'green';
      
//        canvas.addEventListener('mousedown', function(e) {
        
//            if (mediaRecorder.state == "inactive"){
//                mediaRecorder.start()
//                startExpTime = new Date();
//                
//            }
//            else {mediaRecorder.resume()}
////            canvas.addEventListener('mousemove', onPaint, false);
////                       setTimeout(function(){
////                      if (mediaRecorder.state == "recording"){
////                       mediaRecorder.stop();
////                          }
////                      }, 30000);        
//       }, false);
       
        ////////////////////////////////////////////
        // touch listeners
        /////////////////////////////////////////////
        canvas.addEventListener('touchstart', function(e) {
        
            if (mediaRecorder.state == "inactive"){
                mediaRecorder.start()
                startExpTime = new Date();
                
            }
            else {mediaRecorder.resume()}
            canvas.addEventListener('touchmove', onPaint, false);
       }, false);
       
      
//        canvas.addEventListener('mouseup', function(){
        mediaRecorder.pause()
//         canvas.removeEventListener('mousemove', onPaint, false);
         canvas.removeEventListener('touchmove', onPaint, false);
      
      
      }, false);
      
        canvas.addEventListener('touchend', function(){
        mediaRecorder.pause()
//         canvas.removeEventListener('mousemove', onPaint, false);
         canvas.removeEventListener('touchmove', onPaint, false);
      
      
      }, false);
        var onPaint = function() {
            ctx.beginPath();
            ctx.moveTo(last_mouse.x, last_mouse.y);
            strokes.push([last_mouse.x, last_mouse.y, mouse.x, mouse.y]);
            ctx.lineTo(mouse.x, mouse.y);
            ctx.closePath();
            ctx.stroke();
        };
      
      }());
      
   </script>
</body>
</html>


