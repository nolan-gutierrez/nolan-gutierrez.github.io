import csv
import numpy as np
import base64 
from pdb import set_trace as trace
import sys
import imageio as iio

from io import BytesIO
import subprocess, os, platform
from pathlib import Path

from datetime import datetime

csv.field_size_limit(sys.maxsize)


if __name__ == "__main__":
    filename = str(sys.argv[1])  
    np_bytes = BytesIO()
    if 'csv' in filename:
        with open(filename, mode='r') as csv_file:
            csv_reader = csv.DictReader(csv_file)

            line_count = 0
            for row in csv_reader:
                if line_count == 0:
                    print(f'Column names are {", ".join(row)}')
                    line_count += 1
                video = row["video"] 
    #            video_decoded = base64.b64decode(eval(video)["blob"])
    #            video_decoded = video.encode()
                

                video_decoded =  base64.b64decode(eval(video)['blob'][23:])
    #            loaded_b = BytesIO(video_decoded)
    #            loaded_np = np.load(loaded_b, allow_pickle = True)
    #            video_decoded_ascii = video_decoded.encode('ascii')
    #            video_decoded =  eval(video)['blob'][23:]
    #            frames = iio.imread(video_decoded, index = None, format_hint = ".webm")
                image_result = open('temp.webm', 'wb')
                image_result.write(video_decoded)
                print(f"row['WorkerId'] is {row['WorkerId'] } ")
                print(f"row['Symbol'] is {row['Symbol'] } ")
                print(f"row['Size'] is {row['Size'] } ")
                print(f"row['Rotation'] is {row['Rotation'] } ")
                print(f"row['Speed'] is {row['Speed'] } ")
                data1 = row['Symbol']
                data2 = row['Size']
                data3 = row['Rotation']
                data4 = row['Speed']
                   
                now = datetime.now()
                dt_string = now.strftime("-%d-%m-%Y%H:%M:%S")
                video_name = 'amazon_videos/' +  dt_string + data1 + '_' + data2 + '_' + data3 + '_' + data4 + '.webm'
                subprocess.call(('xdg-open', 'temp.webm'))

                input("Press Enter to continue...")
    elif 'txt' in filename:
        with open(filename, 'r') as f: 
            data = f.read() 
            data_eval = eval(data)
            video = data_eval['datalist'][4]['Video']
            data1 = data_eval['datalist'][0]['Symbol']
            data2 = data_eval['datalist'][1]['Size']
            data3 = data_eval['datalist'][2]['Rotation']
            data4 = data_eval['datalist'][3]['Speed']
            video_decoded =  base64.b64decode(eval(video)['blob'][23:])
            now = datetime.now()
            dt_string = now.strftime("-%d-%m-%Y%H:%M:%S_")
            video_name = 'videos/' +  dt_string + data1 + '_' + data2 + '_' + data3 + '_' + data4 + '.webm'
            image_result = open(video_name, 'wb')
            image_result.write(video_decoded)
#            subprocess.call(('xdg-open', video_name))
#            input("Press Enter to continue...")
            
            
        
        

